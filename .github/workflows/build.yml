name: Build
on: [push]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          cat > hook.m << 'EOF'
          #import <UIKit/UIKit.h>
          #include <objc/runtime.h>

          static UIUserInterfaceIdiom fake_idiom(id self, SEL _cmd) {
              return UIUserInterfaceIdiomPhone;
          }

          static UIUserInterfaceIdiom fake_trait_idiom(id self, SEL _cmd) {
              return UIUserInterfaceIdiomPhone;
          }

          static BOOL fake_ipad(id self, SEL _cmd) {
              return NO;
          }

          __attribute__((constructor)) static void init() {
              // Hook UIDevice
              Method m1 = class_getInstanceMethod([UIDevice class], @selector(userInterfaceIdiom));
              method_setImplementation(m1, (IMP)fake_idiom);

              // Hook UITraitCollection
              Method m2 = class_getInstanceMethod([UITraitCollection class], @selector(userInterfaceIdiom));
              method_setImplementation(m2, (IMP)fake_trait_idiom);

              // Hook UIDevice iPad check
              Method m3 = class_getInstanceMethod([UIDevice class], @selector(isIPad));
              if (m3) method_setImplementation(m3, (IMP)fake_ipad);
          }
          EOF
          xcrun clang -arch arm64 \
            -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
            -dynamiclib -framework UIKit -framework Foundation \
            -o iDacsHook.dylib hook.m
      - uses: actions/upload-artifact@v4
        with:
          name: iDacsHook
          path: iDacsHook.dylib
