name: Build
on: [push]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          cat > hook.m << 'EOF'
          #import <UIKit/UIKit.h>
          #include <objc/runtime.h>

          static UIUserInterfaceIdiom fake_idiom(id self, SEL _cmd) {
              return UIUserInterfaceIdiomPhone;
          }

          static UIUserInterfaceSizeClass fake_size_class(id self, SEL _cmd) {
              return UIUserInterfaceSizeClassCompact;
          }

          static BOOL fake_collapsed(id self, SEL _cmd) {
              return YES;
          }

          __attribute__((constructor)) static void init() {
              Method m1 = class_getInstanceMethod([UIDevice class], @selector(userInterfaceIdiom));
              method_setImplementation(m1, (IMP)fake_idiom);

              Method m2 = class_getInstanceMethod([UITraitCollection class], @selector(userInterfaceIdiom));
              method_setImplementation(m2, (IMP)fake_idiom);

              Method m3 = class_getInstanceMethod([UITraitCollection class], @selector(horizontalSizeClass));
              method_setImplementation(m3, (IMP)fake_size_class);

              // 强制 SplitView 折叠
              Method m4 = class_getInstanceMethod([UISplitViewController class], @selector(isCollapsed));
              if (m4) method_setImplementation(m4, (IMP)fake_collapsed);
          }
          EOF
          xcrun clang -arch arm64 \
            -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
            -dynamiclib -framework UIKit -framework Foundation \
            -o iDacsHook.dylib hook.m
      - uses: actions/upload-artifact@v4
        with:
          name: iDacsHook
          path: iDacsHook.dylib
